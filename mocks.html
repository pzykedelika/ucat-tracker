<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UCAT Mock Tracker</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Use Apple‚Äôs SF Pro system font stack */
    html, body, input, button, select, textarea {
      font-family: -apple-system, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
    }
    /* Remove horizontal padding on Date and Section columns */
    table.table-sm th:nth-child(1),
    table.table-sm td:nth-child(1),
    table.table-sm th:nth-child(2),
    table.table-sm td:nth-child(2) {
      padding-left: 0 !important;
      padding-right: 0 !important;
    }
    /* Tighten all table cell padding to shift columns closer together */
    .table td, .table th {
      padding: 0.3rem 0.5rem !important;
    }
    /* Force fixed column widths */
    .table {
      table-layout: fixed;
    }
    /* Override Bootstrap success color for progress bars */
    .progress-bar.bg-success {
      background-color: #19A861 !important;
    }
    /* Change unfilled progress bar background */
    .progress {
      background-color: #E5E5E5 !important;
    }
    /* Vertically center all columns except Date */
    table.table-sm tbody td:not(:first-child) {
      vertical-align: middle !important;
    }
    /* Add horizontal space before Review column */
    table.table-sm td:nth-child(6) {
      padding-left: 1rem !important;
    }

    /* Fixed-height review fields, clickable */
    .review-cell {
      width: 100%;
      border: none;
      background: transparent;
      resize: none;
      overflow: hidden;
      font: inherit;
      height: 2rem;        /* fixed height */
      cursor: pointer;     /* indicate clickable */
    }

    /* Sticky note overlay */
    #noteOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1050;
    }
    .sticky-note {
      background: #ffffff;       /* white background */
      border: 1px solid #e0db7d;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 1rem;
      overflow: auto;
      resize: both;             /* allow resize in both directions */
      position: relative;
      max-width: none !important;
      max-height: none !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Function to toggle the display of the time input based on the hidden timing value
    function toggleTimeField() {
        var timingValue = document.getElementById('timing').value;
        var timeField = document.getElementById('timeInputField');
        if (timingValue === "Timed") {
            timeField.style.display = "block";
        } else {
            timeField.style.display = "none";
        }
    }

    // Function to update the timing value and button styles
    function setTiming(value) {
        document.getElementById('timing').value = value;
        if(value === "Timed") {
            document.getElementById('btnTimed').classList.remove('btn-outline-primary');
            document.getElementById('btnTimed').classList.add('btn-primary');
            document.getElementById('btnUntimed').classList.remove('btn-primary');
            document.getElementById('btnUntimed').classList.add('btn-outline-primary');
        } else {
            document.getElementById('btnUntimed').classList.remove('btn-outline-primary');
            document.getElementById('btnUntimed').classList.add('btn-primary');
            document.getElementById('btnTimed').classList.remove('btn-primary');
            document.getElementById('btnTimed').classList.add('btn-outline-primary');
        }
        toggleTimeField();
    }

    // Function to update the score percentage next to the score input
    function updateScorePercentage() {
        var scoreInput = document.getElementById('score').value;
        var percentageSpan = document.getElementById('scorePercentage');
        // Expect input format like "20/30"
        if(scoreInput.includes("/")) {
            var parts = scoreInput.split("/");
            var obtained = parseFloat(parts[0]);
            var total = parseFloat(parts[1]);
            if(!isNaN(obtained) && !isNaN(total) && total > 0) {
                var percentage = (obtained / total) * 100;
                percentageSpan.textContent = "(" + percentage.toFixed(1) + "% )";
            } else {
                percentageSpan.textContent = "";
            }
        } else {
            percentageSpan.textContent = "";
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the time field display
        toggleTimeField();
        // Attach event listener for score input
        document.getElementById('score').addEventListener('input', updateScorePercentage);
    });
  </script>
</head>
<body>
  <div class="d-flex justify-content-between align-items-center px-4 mt-2">
    <div class="text-muted small">Emmanuel made</div>
    <div id="user-info">
      <div class="input-group input-group-sm">
        <span class="input-group-text">üòπ</span>
        <input type="text" id="usernameInput" class="form-control" placeholder="Username">
      </div>
    </div>
  </div>
<!-- Authentication UI -->
<div id="auth-ui" class="container mt-4">
  <div class="d-flex justify-content-center w-100">
    <button id="btn-login" class="btn btn-primary">Log in / Sign up</button>
  </div>
</div>
<div id="tracker-ui" style="display:none;">
  <div class="container-fluid mt-5">
    <div class="d-flex align-items-center mb-4 ms-4">
      <h1 class="mb-0">Mock Tracker</h1>
      <a href="index.html" class="ms-3" style="font-size:0.9em; text-decoration:none;">‚Üí UCAT Tracker</a>
    </div>
    <div class="mx-auto" style="max-width:2000px; border:1px solid #ccc; padding:1rem;">
    <!-- Card for entering a new score -->
    <div class="card mb-4">
      <div class="card-header">Enter Your Score</div>
      <div class="card-body">
        <form id="scoreForm">
          <!-- A single row of "auto" columns so that each label+input lines up horizontally -->
          <div class="row gx-4 gy-2 align-items-end" style="--bs-gutter-x: 2.5rem;">
            <!-- Date -->
            <div class="col-auto">
              <label for="date" class="col-form-label">Date</label>
              <input type="date" class="form-control" id="date" name="date" required>
            </div>
            <!-- Mock # -->
            <div class="col-auto">
              <label for="mockName" class="col-form-label">Mock #</label>
              <input type="text" class="form-control" id="mockName" name="mockName" placeholder="Mock name" required>
            </div>
            <!-- Platform -->
            <div class="col-auto">
              <label for="platform" class="col-form-label">Platform</label>
              <select id="platform" name="platform" class="form-select" required>
                <option value="" selected disabled>Select Platform</option>
                <option value="Medentry">Medentry</option>
                <option value="Medify">Medify</option>
              </select>
            </div>
            <!-- Score -->
            <div class="col-auto">
              <label for="score" class="col-form-label">Score (x/y)</label>
              <div class="d-flex align-items-center">
                <input type="text" class="form-control" id="score" name="score" required style="width:150px;">
                <span id="scorePercentage" class="ms-2"></span>
              </div>
            </div>
            <!-- Review Notes -->
            <div class="col-md-4">
              <label for="review" class="col-form-label">Review</label>
              <textarea class="form-control" id="review" name="review" rows="1" style="width:100%;" placeholder="Why did you make those mistakes, etc..."></textarea>
            </div>
            <!-- Submit -->
            <div class="col-auto">
              <button type="submit" class="btn btn-primary">Submit Score</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Card for displaying score history -->
    <div class="card">
      <div class="card-header">Mock History</div>
      <div class="card-body">
        <div class="d-flex mb-3">
          <div class="me-3">
            <label for="filterRange" class="form-label">Filter by Date Range:</label>
            <select id="filterRange" class="form-select">
              <option value="All">All Time</option>
              <option value="3days">Past 3 Days</option>
              <option value="1week">Past Week</option>
              <option value="1month">Past Month</option>
              <option value="3months">Past 3 Months</option>
              <option value="6months">Past 6 Months</option>
            </select>
          </div>
          <div class="me-3">
            <label for="filterSection" class="form-label">Filter by Section:</label>
            <select id="filterSection" class="form-select">
              <option value="All">All</option>
              <option value="VR">Verbal Reasoning</option>
              <option value="DM">Decision Making</option>
              <option value="QR">Quantitative Reasoning</option>
            </select>
          </div>
          <div class="me-3">
            <label for="filterTiming" class="form-label">Filter by Timing:</label>
            <select id="filterTiming" class="form-select">
              <option value="All">All</option>
              <option value="Timed">Timed</option>
              <option value="Untimed">Untimed</option>
            </select>
          </div>
          <div class="me-3">
            <label for="filterText" class="form-label">Search:</label>
            <input type="text" id="filterText" class="form-control" placeholder="Search...">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <colgroup>
              <col style="width:7%;" />  <!-- Date -->
              <col style="width:7%;" />  <!-- Mock # -->
              <col style="width:7%;" />  <!-- Platform -->
              <col style="width:5%;" />  <!-- Time -->
              <col style="width:15%;" />  <!-- Score (progress bar) -->
              <col style="width:20%;" />  <!-- Review -->
              <col style="width:5%;" />  <!-- Delete -->
            </colgroup>
            <thead>
              <tr>
                <th>Date</th>
                <th>Mock #</th>
                <th>Platform</th>
                <th>Time</th>
                <th>Score</th>
                <th>Review</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr id="noScoresRow">
                <td colspan="6" class="text-center">No scores yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Section Trend Charts -->
<div class="card mt-4">
  <div class="card-header">Progress</div>
  <div class="card-body">
    <div class="row">
      <!-- VR chart -->
      <div class="col-md-4 text-center">
        <h5>VR</h5>
        <select id="filterVRTiming" class="form-select form-select-sm mb-2">
          <option value="All">All</option>
          <option value="Timed">Timed</option>
          <option value="Untimed">Untimed</option>
        </select>
        <canvas id="chartVR" height="150"></canvas>
      </div>
      <!-- DM chart -->
      <div class="col-md-4 text-center">
        <h5>DM</h5>
        <select id="filterDMTiming" class="form-select form-select-sm mb-2">
          <option value="All">All</option>
          <option value="Timed">Timed</option>
          <option value="Untimed">Untimed</option>
        </select>
        <canvas id="chartDM" height="150"></canvas>
      </div>
      <!-- QR chart -->
      <div class="col-md-4 text-center">
        <h5>QR</h5>
        <select id="filterQRTiming" class="form-select form-select-sm mb-2">
          <option value="All">All</option>
          <option value="Timed">Timed</option>
          <option value="Untimed">Untimed</option>
        </select>
        <canvas id="chartQR" height="150"></canvas>
      </div>
    </div>
  </div>
</div>

  </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js';
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js';
    import { getFirestore, collection, query, where, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js';


    let chartVR, chartDM, chartQR;
    let allEntries = [];
    let scoreChart;

    // Helper to render one score row
    function appendHistoryEntry(entry, id) {
      const tr = document.createElement('tr');
      // Format createdAt timestamp as 12‚Äëhour time with am/pm
      const rawDate = entry.createdAt?.toDate?.();
      const timeStr = rawDate
        ? rawDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true })
        : '';
      // Compute score percentage and decide color
      const [obtained, total] = entry.score.split('/').map(Number);
      const percent = total > 0 ? Math.round((obtained / total) * 100) : 0;
      let barClass;
      if (percent < 50) barClass = 'bg-danger';
      else if (percent < 80) barClass = 'bg-warning';
      else barClass = 'bg-success';
      tr.innerHTML = `
        <td>
          ${entry.date}<br>
          <small class="text-muted">
            ${timeStr}
          </small>
        </td>
        <td>${entry.mockName}</td>
        <td>${entry.platform}</td>
        <td>${entry.time}</td>
        <td>
          <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 1rem;">
              <div class="progress-bar ${barClass}" role="progressbar"
                   style="width: ${percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
            <span>
              ${entry.score} <small class="text-muted ms-2">${percent}%</small>
            </span>
          </div>
        </td>
        <td>
          <textarea class="review-cell" readonly>${entry.review || ''}</textarea>
        </td>
        <td style="padding-left: 1rem; padding-right: 0.5rem;">
          <button class="btn btn-sm btn-outline-danger" onclick="deleteScore('${id}')">üóëÔ∏è</button>
        </td>
      `;
      document.getElementById('historyBody').appendChild(tr);
      // Attach overlay click on this row's review textarea
      const overlay = document.getElementById('noteOverlay');
      const noteContent = document.getElementById('noteContent');
      const ta = tr.querySelector('.review-cell');
      if (ta) {
        ta.addEventListener('click', () => {
          noteContent.textContent = ta.value;
          overlay.style.display = 'flex';
        });
      }
    }

    // Firebase config
    const firebaseConfig = {
      apiKey: 'AIzaSyCb0Ru1X1EUeGVU0GAttLbsEsje_KQJKeo',
      authDomain: 'ucat-e1503.firebaseapp.com',
      projectId: 'ucat-e1503',
      storageBucket: 'ucat-e1503.firebasestorage.app',
      messagingSenderId: '607003588773',
      appId: '1:607003588773:web:4bb1c9d5534b4059af754c',
      measurementId: 'G-9R1TST35JH'
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // UI containers
    document.getElementById('btn-login');
    const authUI    = document.getElementById('auth-ui');
    const trackerUI = document.getElementById('tracker-ui');
    const loginBtn  = document.getElementById('btn-login');

    // Auth state handling
    loginBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
    onAuthStateChanged(auth, user => {
      const userInfo = document.getElementById('user-info');
      if (user) {
        authUI.style.display    = 'none';
        trackerUI.style.display = 'block';
        const usernameInput = document.getElementById('usernameInput');
        // Load saved username or default to email
        const saved = localStorage.getItem('username_' + user.uid);
        usernameInput.value = saved || user.email;
        usernameInput.style.display = 'inline-block';
        loadScores();
      } else {
        authUI.style.display    = 'flex';
        trackerUI.style.display = 'none';
        // Hide username input on logout
        document.getElementById('usernameInput').style.display = 'none';
        userInfo.textContent    = '';
      }
    });

    // Save username on change
    document.getElementById('usernameInput').addEventListener('change', () => {
      const user = auth.currentUser;
      if (user) localStorage.setItem('username_' + user.uid, document.getElementById('usernameInput').value.trim());
    });
 
    // Load scores for current user via onSnapshot, then sort client-side
    function loadScores() {
      const user = auth.currentUser;
      if (!user) return;
      const tbody = document.getElementById('historyBody');
      // Clear existing rows
      tbody.innerHTML = '';
      // Build a query for this user's docs (no orderBy)
      const scoresRef = collection(db, 'mocks');
      const q = query(scoresRef, where('userId', '==', user.uid));
      // Subscribe to real-time updates
      onSnapshot(q, snapshot => {
        allEntries = snapshot.docs
          .map(docSnap => ({ id: docSnap.id, data: docSnap.data() }))
          .sort((a, b) => {
            // Safely extract creation timestamps, default to epoch
            const aDate = a.data.createdAt?.toDate?.() || new Date(0);
            const bDate = b.data.createdAt?.toDate?.() || new Date(0);
            return bDate - aDate;
          });
        renderTable();
      }, err => {
        console.error('[Firestore] onSnapshot failed:', err);
      });
    }

    // Attach filter event listeners once
    document.getElementById('filterSection').addEventListener('change', renderTable);
    document.getElementById('filterTiming').addEventListener('change', renderTable);
    document.getElementById('filterVRTiming').addEventListener('change', renderTable);
    document.getElementById('filterDMTiming').addEventListener('change', renderTable);
    document.getElementById('filterQRTiming').addEventListener('change', renderTable);
    document.getElementById('filterRange').addEventListener('change', renderTable);
    document.getElementById('filterText').addEventListener('input', renderTable);

    function renderTable() {
      const tbody = document.getElementById('historyBody');
      const sectionFilter = document.getElementById('filterSection').value;
      const timingFilter  = document.getElementById('filterTiming').value;
      const rangeFilter = document.getElementById('filterRange').value;
      const textFilter = document.getElementById('filterText').value.trim().toLowerCase();
      let threshold = null;
      const now = new Date();
      switch (rangeFilter) {
        case '3days':   threshold = new Date(now - 3*24*60*60*1000); break;
        case '1week':   threshold = new Date(now - 7*24*60*60*1000); break;
        case '1month':  threshold = new Date(now.setMonth(now.getMonth() - 1)); break;
        case '3months': threshold = new Date(now.setMonth(now.getMonth() - 3)); break;
        case '6months': threshold = new Date(now.setMonth(now.getMonth() - 6)); break;
        default:        threshold = null;
      }
      tbody.innerHTML = '';
      const filtered = allEntries.filter(({ data }) => {
        const sectionOk = (sectionFilter === 'All' || data.section === sectionFilter);
        const timingOk  = (timingFilter  === 'All' || data.timing  === timingFilter);
        const dateOk = !threshold || (data.createdAt?.toDate?.() >= threshold);
        const combined = [data.date, data.section, data.timing, data.time, data.score, data.review || '']
          .join(' ').toLowerCase();
        const textOk = !textFilter || combined.includes(textFilter);
        return sectionOk && timingOk && dateOk && textOk;
      });
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr id="noScoresRow"><td colspan="6" class="text-center">No scores found.</td></tr>`;
      } else {
        filtered.forEach(({ data, id }) => appendHistoryEntry(data, id));
      }
      // updateChart(filtered);  // Removed single-chart code
      chartVR = updateSectionChart('VR', document.getElementById('filterVRTiming').value, chartVR, 'chartVR');
      chartDM = updateSectionChart('DM', document.getElementById('filterDMTiming').value, chartDM, 'chartDM');
      chartQR = updateSectionChart('QR', document.getElementById('filterQRTiming').value, chartQR, 'chartQR');
    }

    // updateChart function removed (single-chart code)
    function updateSectionChart(section, timingFilterValue, chartVar, canvasId) {
  const entries = allEntries
    .filter(({ data }) => data.section === section)
    .filter(({ data }) => timingFilterValue === 'All' || data.timing === timingFilterValue)
    .sort((a, b) => {
      const aDate = a.data.createdAt?.toDate?.() || new Date(0);
      const bDate = b.data.createdAt?.toDate?.() || new Date(0);
      return aDate - bDate;
    });

  const labels = entries.map(e => e.data.date);
  const values = entries.map(e => {
    const [obt, tot] = e.data.score.split('/').map(Number);
    return tot > 0 ? (obt / tot) * 100 : 0;
  });

  const ctx = document.getElementById(canvasId).getContext('2d');
  const cfg = {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: '% Correct',
        data: values,
        segment: {
          borderColor: ctx =>
            ctx.p1.parsed.y >= ctx.p0.parsed.y
              ? '#19A861'
              : '#D62C2C'
        },
        fill: false,
        tension: 0.1,
        pointRadius: 4
      }]
    },
    options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
  };

  if (!chartVar) return new Chart(ctx, cfg);
  chartVar.data.labels = labels;
  chartVar.data.datasets[0].data = values;
  chartVar.update();
  return chartVar;
}
    async function addScore(entry) {
      entry.userId = auth.currentUser.uid;
      entry.createdAt = serverTimestamp();
      entry.review = document.getElementById('review').value;
      try {
        const docRef = await addDoc(collection(db, 'mocks'), entry);
        console.log('[Firestore] addDoc succeeded, ID:', docRef.id, entry);
      } catch (err) {
        console.error('[Firestore] addDoc failed:', err);
        alert('Failed to save score: ' + err.message);
        throw err;
      }
    }

    async function deleteScore(id) {
      try {
        await deleteDoc(doc(db, 'mocks', id));
        console.log('[Firestore] deleted', id);
      } catch (err) {
        console.error('[Firestore] delete failed:', err);
        alert('Failed to delete: ' + err.message);
      }
    }
    window.deleteScore = deleteScore;
 
    // Form submission
    document.getElementById('scoreForm').addEventListener('submit', async e => {
      e.preventDefault();
      const entry = {
        date: document.getElementById('date').value,
        mockName: document.getElementById('mockName').value,
        platform: document.getElementById('platform').value,
        time: 0,
        score: document.getElementById('score').value
      };
      await addScore(entry);
      loadScores();
      e.target.reset(); updateScorePercentage();
    });

    // Remove auto-resize for form review textarea
  </script>
</div>
</div>
</div>
<!-- Sticky-note overlay for Reviews -->
<div id="noteOverlay">
  <div class="sticky-note">
    <button id="noteClose" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close"></button>
    <div id="noteContent" style="white-space: pre-wrap;"></div>
  </div>
</div>
<script>
// Only handle overlay close logic globally (not review open, which is now per-row)
document.getElementById('noteClose').addEventListener('click', function() {
  document.getElementById('noteOverlay').style.display = 'none';
});
</script>
</body>
</html>